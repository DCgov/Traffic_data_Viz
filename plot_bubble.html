<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/d3/2.7.4/d3.layout.min.js"></script>
    <script src="js/loading_indicator.js"></script>
    <link rel="stylesheet" type="text/css" href="css/loading_indicator.css">
    <style type="text/css">
        body {
            font: 12px sans-serif;
        }
        text {
          font-size: 11px;
          pointer-events: none;
        }

        text.parent {
          fill: #1f77b4;
        }

        circle {
          fill: #ccc;
          stroke: #999;
          pointer-events: all;
        }

        circle.parent {
          fill: #1f77b4;
          fill-opacity: .1;
          stroke: steelblue;
        }

        circle.parent:hover {
          stroke: #ff7f0e;
          stroke-width: .5px;
        }

        circle.child {
          pointer-events: none;
        }
    </style>
</head>
<body>

<form>
    Start_DateTime <i>(YYYY-MM-DD H:M:S)</i>: <input type="text" id="startdate" value="2013-10-01 00:00:00">
    End_DateTime <i>(YYYY-MM-DD H:M:S)</i>: <input type="text" id="enddate" value="2013-10-02 00:00:00">
    Direction:
    <select id="dir">
        <option value="all">all</option>
        <option value="NS">N&S</option>
        <option value="WE">W&E</option>
        <option value="N">N</option>
        <option value="S">S</option>
        <option value="W">W</option>
        <option value="E">E</option>
        <option value="RL">RL</option>
    </select>
    <input type="button" value="Generate" onclick="generate()">
</form>


<p><i>This visualization takes a few seconds to process. The newest figure will be appended at the end of page.</i></p>
<hr>

<div id="plotarea"></div>

<script type="text/javascript">
    var w = 1280,
        h = 800,
        r = 720,
        x = d3.scale.linear().range([0, r]),
        y = d3.scale.linear().range([0, r]),
        node,
        root;

    var pack = d3.layout.pack()
        .size([r, r])
        .value(function(d) { return d.volume; })

    var vis = d3.select("#plotarea").insert("svg:svg", "h2")
        .attr("width", w)
        .attr("height", h)
      .append("svg:g")
        .attr("transform", "translate(" + (w - r) / 2 + "," + (h - r) / 2 + ")");


    var nodes = null;

    function generate() {
        loading_indicator_trigger();
        if(nodes != null){
            $("#plotarea").html("");
            vis = d3.select("#plotarea").insert("svg:svg", "h2")
                .attr("width", w)
                .attr("height", h)
              .append("svg:g")
                .attr("transform", "translate(" + (w - r) / 2 + "," + (h - r) / 2 + ")");
            nodes = null;

        }

        query = "http://10.41.20.61:10808/dataviz/datavizcgi.py?method=query_by_time_region&target_plot=BBL&start_date=" + $("#startdate").val() + "&end_date=" + $("#enddate").val() + "&dir=" + $("#dir option:selected").val();
        console.log("load started.");

        d3.json(query, function (data) {
            node = root = data;

            nodes = pack.nodes(root);

            vis.selectAll("circle")
                    .data(nodes)
                    .enter().append("svg:circle")
                    .attr("class", function (d) {
                        return d.children ? "parent" : "child";
                    })
                    .attr("cx", function (d) {
                        return d.x;
                    })
                    .attr("cy", function (d) {
                        return d.y;
                    })
                    .attr("r", function (d) {
                        return d.r;
                    })
                    .on("click", function (d) {
                        return zoom(node == d ? root : d);
                    });

            vis.selectAll("text")
                    .data(nodes)
                    .enter().append("svg:text")
                    .attr("class", function (d) {
                        return d.children ? "parent" : "child";
                    })
                    .attr("x", function (d) {
                        return d.x;
                    })
                    .attr("y", function (d) {
                        return d.y;
                    })
                    .attr("dy", ".15em")
                    .attr("text-anchor", "middle")
                    .style("opacity", function (d) {
                        return d.r > 20 ? 1 : 0;
                    })
                    .text(function (d) {
                        return d.name;
                    });

            d3.select(window).on("click", function () {
                zoom(root);
            });

            console.log("load finished.");
            loading_indicator_trigger();
        });
    }

    function zoom(d, i) {
      var k = r / d.r / 2;
      x.domain([d.x - d.r, d.x + d.r]);
      y.domain([d.y - d.r, d.y + d.r]);

      var t = vis.transition()
          .duration(d3.event.altKey ? 7500 : 750);

      t.selectAll("circle")
          .attr("cx", function(d) { return x(d.x); })
          .attr("cy", function(d) { return y(d.y); })
          .attr("r", function(d) { return k * d.r; });

      t.selectAll("text")
          .attr("x", function(d) { return x(d.x); })
          .attr("y", function(d) { return y(d.y); })
          .style("opacity", function(d) { return k * d.r > 20 ? 1 : 0; });

      node = d;
      d3.event.stopPropagation();
    }

</script>